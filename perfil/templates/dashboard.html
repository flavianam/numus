{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - NUMUS</title>
    <link href="{% static 'perfil/css/home.css' %}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: var(--fundo-tela);
        }
        .card-title {
            background-color: var(--fundo-blocos);
            padding: 12px 15px;
            font-weight: 600;
            color: #333;
            border-bottom: 1px solid #e5e7eb;
            margin: 0;
        }
    </style>
</head>

<body>
    <!-- MENU LATERAL -->
    {% include 'includes/sidebar.html' %}

    <!-- CONTEÚDO PRINCIPAL -->
    <div class="main-content">
        <!-- HEADER -->
        <div class="header">
            <h1 class="header-title">Dashboard</h1>
            <a class="logo" aria-label="Logo" title="Logo"><img src="{% static 'perfil/img/logo.png' %}" alt="Logo"></a>
        </div>

        <!-- GREETING -->
        <div class="greeting">
            <h2>Visualize sua evolução financeira</h2>
            <p>Acompanhe entradas, gastos e investimentos ao longo dos meses.</p>
        </div>

        <div class="container">
            <div class="row mb-3">
                <div class="col-md-4">
                    <form method="get" class="d-flex gap-2">
                        <select name="month" class="form-select">
                            <option value="1" {% if selected_month == 1 %}selected{% endif %}>Janeiro</option>
                            <option value="2" {% if selected_month == 2 %}selected{% endif %}>Fevereiro</option>
                            <option value="3" {% if selected_month == 3 %}selected{% endif %}>Março</option>
                            <option value="4" {% if selected_month == 4 %}selected{% endif %}>Abril</option>
                            <option value="5" {% if selected_month == 5 %}selected{% endif %}>Maio</option>
                            <option value="6" {% if selected_month == 6 %}selected{% endif %}>Junho</option>
                            <option value="7" {% if selected_month == 7 %}selected{% endif %}>Julho</option>
                            <option value="8" {% if selected_month == 8 %}selected{% endif %}>Agosto</option>
                            <option value="9" {% if selected_month == 9 %}selected{% endif %}>Setembro</option>
                            <option value="10" {% if selected_month == 10 %}selected{% endif %}>Outubro</option>
                            <option value="11" {% if selected_month == 11 %}selected{% endif %}>Novembro</option>
                            <option value="12" {% if selected_month == 12 %}selected{% endif %}>Dezembro</option>
                        </select>

                        <input type="number" name="year" class="form-control" value="{{ selected_year }}" style="width:120px">
                        <button class="botao-principal" type="submit">Filtrar</button>
                    </form>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    {% if meses_labels %}
                        <div class="card" style="margin-bottom: 24px; background-color: var(--fundo-blocos); border: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div class="card-title">Evolução Financeira — {{ selected_year }}</div>
                            <div class="card-body" style="height:420px; padding:15px">
                                <canvas id="evolutionChart"></canvas>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    {% if labels and values and labels|length > 0 %}
                        <div class="card" style="background-color: var(--fundo-blocos); border: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div class="card-title">Gastos por categoria — {{ selected_month }}/{{ selected_year }}</div>
                            <div class="card-body" style="height:420px; padding:15px">
                                <canvas id="myChart"></canvas>
                            </div>
                        </div>
                    {% else %}
                        <div class="card" style="background-color: var(--fundo-blocos); border: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div class="card-body">Sem dados para o período selecionado.</div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    {% if meses_labels %}
        <script>
            (function(){
                const ctx = document.getElementById('evolutionChart').getContext('2d');
                const data = {
                    labels: {{ meses_labels|safe }},
                    datasets: [
                        {
                            label: 'Recebido',
                            data: {{ entradas_data|safe }},
                            borderColor: '#14b8a6',
                            backgroundColor: 'rgba(20, 184, 166, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#14b8a6'
                        },
                        {
                            label: 'Gasto',
                            data: {{ gastos_data|safe }},
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#ef4444'
                        },
                    ]
                };

                new Chart(ctx, {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { 
                                display: true,
                                position: 'bottom'
                            },
                            filler: { propagate: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Valor (R$)' },
                                ticks: { callback: function(value) { return 'R$ ' + value.toFixed(0); } }
                            }
                        }
                    }
                });
            })();
        </script>
    {% endif %}
    
    {% if labels and values and labels|length > 0 %}
        <script>
            (function(){
                const ctx = document.getElementById('myChart').getContext('2d');
                const data = {
                    labels: {{ labels|safe }},
                    datasets: [{
                        label: 'Gastos',
                        data: {{ values|safe }},
                        backgroundColor: {{ colors|safe }},
                        borderColor: {{ colors|safe }},
                        borderWidth: 1
                    }]
                };

                new Chart(ctx, {
                    type: 'bar',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            })();
        </script>
    {% endif %}

</body>
</html>
